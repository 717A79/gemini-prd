
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调拨计划“取消审核”功能 - 需求设计文档</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; }
        .enterprise-green { background-color: #008c5e; }
        .enterprise-green-text { color: #008c5e; }
        .doc-section { scroll-margin-top: 80px; }
        .status-badge { font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid transparent; font-weight: 500; }
        .status-audited { color: #16a34a; background-color: #f0fdf4; border-color: #bbf7d0; }
        .status-pending { color: #d97706; background-color: #fffbeb; border-color: #fef3c7; }
        .status-cancelled { color: #dc2626; background-color: #fef2f2; border-color: #fecaca; }
        .status-searching { color: #2563eb; background-color: #eff6ff; border-color: #bfdbfe; }
        
        .nav-link.active { border-left: 4px solid #008c5e; background-color: #f0fdf4; color: #008c5e; font-weight: 600; }
        
        /* Prototype specific */
        .prototype-container { border: 2px dashed #e5e7eb; border-radius: 12px; overflow: hidden; }
        
        @media print {
            .no-print { display: none; }
            .print-break { page-break-before: always; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 leading-relaxed">

    <!-- Sidebar Navigation (Desktop) -->
    <aside class="no-print fixed left-0 top-0 h-screen w-64 bg-white border-r border-slate-200 p-6 hidden lg:block overflow-y-auto">
        <div class="flex items-center mb-10 space-x-2">
            <div class="w-8 h-8 enterprise-green rounded-md flex items-center justify-center text-white">
                <i class="fas fa-file-signature"></i>
            </div>
            <span class="font-bold text-lg">设计说明书</span>
        </div>
        
        <nav class="space-y-1 text-sm">
            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">目录</p>
            <a href="#section-intro" class="nav-link block px-4 py-2 rounded-md hover:bg-slate-50 transition-colors">1. 项目背景</a>
            <a href="#section-goals" class="nav-link block px-4 py-2 rounded-md hover:bg-slate-50 transition-colors">2. 业务目标</a>
            <a href="#section-flow" class="nav-link block px-4 py-2 rounded-md hover:bg-slate-50 transition-colors">3. 业务流转图</a>
            <a href="#section-specs" class="nav-link block px-4 py-2 rounded-md hover:bg-slate-50 transition-colors">4. 功能规格说明</a>
            <a href="#section-interaction" class="nav-link block px-4 py-2 rounded-md hover:bg-slate-50 transition-colors">5. 交互原型演示</a>
            <a href="#section-tech" class="nav-link block px-4 py-2 rounded-md hover:bg-slate-50 transition-colors">6. 技术实现建议</a>
        </nav>
        
        <div class="mt-auto pt-10 text-xs text-slate-400">
            <p>文档版本：V1.1</p>
            <p>更新日期：2024-05-20</p>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="lg:ml-64 p-4 lg:p-10 max-w-5xl">
        
        <!-- Header / Cover -->
        <header class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 mb-10">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900 mb-2">调拨计划“取消审核”功能设计文档</h1>
                    <p class="text-slate-500">旨在优化单据录入错误后的修改成本，提升系统易用性。</p>
                </div>
                <button onclick="window.print()" class="no-print self-start flex items-center px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium transition-colors">
                    <i class="fas fa-print mr-2"></i> 导出 PDF
                </button>
            </div>
        </header>

        <!-- Section 1: Intro -->
        <section id="section-intro" class="doc-section bg-white p-8 rounded-2xl shadow-sm border border-slate-200 mb-10">
            <h2 class="text-xl font-bold text-slate-900 mb-6 flex items-center">
                <span class="w-8 h-8 enterprise-green rounded flex items-center justify-center text-white text-xs mr-3">01</span>
                项目背景与痛点
            </h2>
            <div class="space-y-4 text-slate-600">
                <p>目前在<strong>调拨计划管理模块</strong>中，用户反馈单据审核后的容错能力极低：</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-red-50 border border-red-100 rounded-xl">
                        <h4 class="font-bold text-red-700 mb-1 italic">现状：无回头路</h4>
                        <p class="text-sm">单据一旦审核，所有字段锁定。如需修改，只能“取消”（作废），此操作不可逆。</p>
                    </div>
                    <div class="p-4 bg-orange-50 border border-orange-100 rounded-xl">
                        <h4 class="font-bold text-orange-700 mb-1 italic">后果：高重复劳动</h4>
                        <p class="text-sm">作废后必须手动重新创建新单据，对于包含数十行明细的复杂单据，用户抵触情绪强烈。</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Goals -->
        <section id="section-goals" class="doc-section bg-white p-8 rounded-2xl shadow-sm border border-slate-200 mb-10">
            <h2 class="text-xl font-bold text-slate-900 mb-6 flex items-center">
                <span class="w-8 h-8 enterprise-green rounded flex items-center justify-center text-white text-xs mr-3">02</span>
                业务目标
            </h2>
            <div class="space-y-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-check-circle text-green-500 mt-1"></i>
                    <p><span class="font-bold">状态回滚：</span>支持已审核单据回滚至“待审核”状态。</p>
                </div>
                <div class="flex items-start space-x-3">
                    <i class="fas fa-check-circle text-green-500 mt-1"></i>
                    <p><span class="font-bold">数据保留：</span>无需重新创建单据，保留原有所有业务信息，仅变更单据状态及解锁字段。</p>
                </div>
                <div class="flex items-start space-x-3">
                    <i class="fas fa-check-circle text-green-500 mt-1"></i>
                    <p><span class="font-bold">风险受控：</span>限制仅在单据未进入下发、寻源等后续执行环节前允许取消审核。</p>
                </div>
            </div>
        </section>

        <!-- Section 3: Flow -->
        <section id="section-flow" class="doc-section bg-white p-8 rounded-2xl shadow-sm border border-slate-200 mb-10">
            <h2 class="text-xl font-bold text-slate-900 mb-6 flex items-center">
                <span class="w-8 h-8 enterprise-green rounded flex items-center justify-center text-white text-xs mr-3">03</span>
                业务流程变更
            </h2>
            <div class="p-6 bg-slate-50 border border-slate-200 rounded-xl flex flex-col items-center">
                <!-- Simple SVG Flowchart -->
                <div class="flex flex-wrap items-center justify-center gap-4 text-sm font-medium">
                    <div class="px-4 py-2 bg-white border border-slate-300 rounded shadow-sm">草稿/待审核</div>
                    <i class="fas fa-arrow-right text-slate-400"></i>
                    <div class="flex flex-col items-center">
                        <div class="px-4 py-2 bg-green-100 border border-green-300 text-green-800 rounded shadow-sm font-bold">已审核</div>
                        <!-- New Return Path -->
                        <div class="mt-2 text-orange-600 flex flex-col items-center">
                            <i class="fas fa-long-arrow-alt-up"></i>
                            <span class="text-[10px] bg-orange-100 px-1 rounded">取消审核 (新增路径)</span>
                        </div>
                    </div>
                    <i class="fas fa-arrow-right text-slate-400"></i>
                    <div class="px-4 py-2 bg-slate-200 border border-slate-300 text-slate-500 rounded">已下发/执行</div>
                </div>
                <p class="mt-8 text-xs text-slate-400 italic">流程说明：取消审核仅适用于处于中间状态“已审核”的单据。</p>
            </div>
        </section>

        <!-- Section 4: Specs -->
        <section id="section-specs" class="doc-section bg-white p-8 rounded-2xl shadow-sm border border-slate-200 mb-10">
            <h2 class="text-xl font-bold text-slate-900 mb-6 flex items-center">
                <span class="w-8 h-8 enterprise-green rounded flex items-center justify-center text-white text-xs mr-3">04</span>
                功能规格说明
            </h2>
            <div class="overflow-hidden border border-slate-200 rounded-xl">
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="p-4 font-bold text-slate-700 w-1/4">要素</th>
                            <th class="p-4 font-bold text-slate-700">规格描述</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr>
                            <td class="p-4 bg-slate-50/30 font-medium">操作入口</td>
                            <td class="p-4">调拨计划列表页的操作栏，位于“审核”之后，“取消”之前。</td>
                        </tr>
                        <tr>
                            <td class="p-4 bg-slate-50/30 font-medium">可用条件</td>
                            <td class="p-4">勾选的单据 [状态] 必须全为 "已审核"。且对应单据未生成下游指令单。</td>
                        </tr>
                        <tr>
                            <td class="p-4 bg-slate-50/30 font-medium">权限要求</td>
                            <td class="p-4">具有 "调拨计划审核" 权限的用户默认具备 "取消审核" 权限。</td>
                        </tr>
                        <tr>
                            <td class="p-4 bg-slate-50/30 font-medium">异常处理</td>
                            <td class="p-4">若批量勾选中包含非 "已审核" 状态单据，按钮应禁用或在点击后弹出警告提示。</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Section 5: Interaction (Prototype) -->
        <section id="section-interaction" class="doc-section bg-white p-8 rounded-2xl shadow-sm border border-slate-200 mb-10">
            <h2 class="text-xl font-bold text-slate-900 mb-6 flex items-center">
                <span class="w-8 h-8 enterprise-green rounded flex items-center justify-center text-white text-xs mr-3">05</span>
                交互原型演示
            </h2>
            
            <div class="mb-4 flex items-center justify-between">
                <p class="text-sm text-slate-500">此区域为模拟系统真实环境的交互演示，您可以直接进行操作测试。</p>
                <div class="flex space-x-2">
                    <span class="flex items-center text-[10px] text-green-600 bg-green-50 px-2 py-1 rounded">
                        <i class="fas fa-mouse-pointer mr-1"></i> 可点击
                    </span>
                </div>
            </div>

            <!-- Prototype Wrapper -->
            <div class="prototype-container bg-white shadow-2xl">
                <!-- System Toolbar -->
                <div class="bg-white px-4 py-3 border-b border-slate-200 flex flex-wrap items-center gap-2">
                    <button class="px-3 py-1 bg-green-600 text-white rounded text-xs font-medium hover:bg-green-700 transition-colors">
                        <i class="fas fa-plus mr-1"></i> 新增
                    </button>
                    <button onclick="mockAudit()" class="px-3 py-1 bg-slate-100 text-slate-700 border border-slate-300 rounded text-xs font-medium hover:bg-slate-200">
                        <i class="fas fa-check-double mr-1 text-green-600"></i> 审核
                    </button>
                    
                    <!-- THE NEW BUTTON -->
                    <button id="proto-cancel-audit" onclick="showCancelAuditModal()" disabled class="px-3 py-1 bg-slate-100 text-slate-400 border border-slate-200 rounded text-xs font-medium cursor-not-allowed">
                        <i class="fas fa-history mr-1 text-orange-400"></i> 取消审核
                    </button>
                    
                    <button class="px-3 py-1 bg-slate-100 text-slate-700 border border-slate-300 rounded text-xs font-medium hover:bg-slate-200">
                        <i class="fas fa-times mr-1 text-red-500"></i> 取消
                    </button>
                    <div class="h-4 w-[1px] bg-slate-300 mx-1"></div>
                    <input id="proto-search" oninput="renderProtoTable()" type="text" placeholder="搜索单号..." class="px-2 py-1 border border-slate-200 rounded text-xs outline-none focus:ring-1 focus:ring-green-500 w-32">
                </div>

                <!-- System Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold uppercase">
                            <tr>
                                <th class="p-3 w-8"><input type="checkbox" onclick="toggleAllProto(this)"></th>
                                <th class="p-3">来源单号</th>
                                <th class="p-3">业务类型</th>
                                <th class="p-3">收货账仓</th>
                                <th class="p-3 text-center">状态</th>
                                <th class="p-3">创建时间</th>
                            </tr>
                        </thead>
                        <tbody id="proto-table-body" class="divide-y divide-slate-100">
                            <!-- Injected rows -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Prototype Footer Info -->
                <div class="bg-slate-50 px-4 py-2 text-[10px] text-slate-400 flex justify-between border-t border-slate-200">
                    <span>共 <span id="proto-count">0</span> 条数据</span>
                    <span>模拟环境 v1.0</span>
                </div>
            </div>
        </section>

        <!-- Section 6: Tech -->
        <section id="section-tech" class="doc-section bg-white p-8 rounded-2xl shadow-sm border border-slate-200 mb-10">
            <h2 class="text-xl font-bold text-slate-900 mb-6 flex items-center">
                <span class="w-8 h-8 enterprise-green rounded flex items-center justify-center text-white text-xs mr-3">06</span>
                技术实现建议
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-3">
                    <h4 class="font-bold text-slate-800 text-sm">后端接口调整</h4>
                    <ul class="text-xs text-slate-600 space-y-2 list-disc pl-4">
                        <li>新增 <code>POST /transfer/plan/audit/cancel</code> 接口。</li>
                        <li>内部逻辑：校验是否已生成后续作业，若无则执行 <code>status update = 10 (待审核)</code>。</li>
                        <li>事务处理：必须确保状态变更与操作日志写入在同一事务。</li>
                    </ul>
                </div>
                <div class="space-y-3">
                    <h4 class="font-bold text-slate-800 text-sm">数据库变更</h4>
                    <ul class="text-xs text-slate-600 space-y-2 list-disc pl-4">
                        <li>操作日志表 <code>op_log</code> 增加 "CANCEL_AUDIT" 类型。</li>
                        <li>调拨单主表记录最后一次取消审核的时间与操作人 ID。</li>
                    </ul>
                </div>
            </div>
        </section>

    </div>

    <!-- Modal for Cancel Audit -->
    <div id="cancel-modal" class="hidden fixed inset-0 z-[1000] flex items-center justify-center bg-black/40 backdrop-blur-[2px]">
        <div class="bg-white rounded-xl shadow-2xl w-[420px] overflow-hidden transform scale-95 opacity-0 transition-all duration-200 ease-out" id="modal-content">
            <div class="p-6">
                <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 mb-4">
                    <i class="fas fa-exclamation-triangle text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 mb-2">确认取消审核？</h3>
                <p id="modal-desc" class="text-sm text-slate-500 mb-4">
                    取消后，选中的单据将返回“待审核”状态，您可以重新对其进行编辑修改。
                </p>
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-100 mb-4">
                    <p class="text-[11px] text-slate-400 uppercase font-bold mb-1">选中的单据 ID</p>
                    <p id="modal-ids" class="text-xs font-mono text-slate-700 truncate"></p>
                </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-end space-x-3 border-t border-slate-200">
                <button onclick="hideCancelAuditModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition-colors">取消</button>
                <button onclick="confirmProtoCancelAudit()" class="px-4 py-2 text-sm font-medium bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors shadow-sm">确认取消审核</button>
            </div>
        </div>
    </div>

    <script>
        // Prototype Logic
        let protoData = [
            { id: 'BK001', type: '实物调拨', warehouse: '珠海一仓', status: '已审核', date: '2024-05-18' },
            { id: 'BK002', type: '样品调拨', warehouse: '广州分仓', status: '待审核', date: '2024-05-19' },
            { id: 'BK003', type: '实物调拨', warehouse: '合肥基地', status: '已审核', date: '2024-05-19' },
            { id: 'BK004', type: '实物调拨', warehouse: '深圳南山', status: '已取消', date: '2024-05-20' },
            { id: 'BK005', type: '样品调拨', warehouse: '珠海二仓', status: '待审核', date: '2024-05-20' }
        ];
        
        let protoSelected = new Set();

        function renderProtoTable() {
            const body = document.getElementById('proto-table-body');
            const search = document.getElementById('proto-search').value.toLowerCase();
            const filtered = protoData.filter(i => i.id.toLowerCase().includes(search));
            
            body.innerHTML = '';
            filtered.forEach(item => {
                const isSelected = protoSelected.has(item.id);
                const row = document.createElement('tr');
                row.className = `hover:bg-slate-50 transition-colors ${isSelected ? 'bg-blue-50/50' : ''}`;
                
                let badgeClass = 'status-badge ';
                if (item.status === '已审核') badgeClass += 'status-audited';
                else if (item.status === '待审核') badgeClass += 'status-pending';
                else if (item.status === '已取消') badgeClass += 'status-cancelled';

                row.innerHTML = `
                    <td class="p-3"><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelectProto('${item.id}')"></td>
                    <td class="p-3 font-medium text-slate-900">${item.id}</td>
                    <td class="p-3">${item.type}</td>
                    <td class="p-3">${item.warehouse}</td>
                    <td class="p-3 text-center"><span class="${badgeClass}">${item.status}</span></td>
                    <td class="p-3 text-slate-400">${item.date}</td>
                `;
                body.appendChild(row);
            });
            
            document.getElementById('proto-count').innerText = filtered.length;
            updateProtoButtons();
        }

        function toggleSelectProto(id) {
            if (protoSelected.has(id)) protoSelected.delete(id);
            else protoSelected.add(id);
            renderProtoTable();
        }

        function toggleAllProto(el) {
            if (el.checked) {
                protoData.forEach(i => protoSelected.add(i.id));
            } else {
                protoSelected.clear();
            }
            renderProtoTable();
        }

        function updateProtoButtons() {
            const btn = document.getElementById('proto-cancel-audit');
            const selectedItems = protoData.filter(i => protoSelected.has(i.id));
            
            const canCancel = selectedItems.length > 0 && selectedItems.every(i => i.status === '已审核');
            
            if (canCancel) {
                btn.disabled = false;
                btn.className = "px-3 py-1 bg-white text-orange-600 border border-orange-200 rounded text-xs font-medium hover:bg-orange-50 transition-colors shadow-sm cursor-pointer";
            } else {
                btn.disabled = true;
                btn.className = "px-3 py-1 bg-slate-50 text-slate-300 border border-slate-200 rounded text-xs font-medium cursor-not-allowed";
            }
        }

        function mockAudit() {
            if (protoSelected.size === 0) return alert('请先勾选状态为“待审核”的单据');
            let count = 0;
            protoData = protoData.map(item => {
                if (protoSelected.has(item.id) && item.status === '待审核') {
                    count++;
                    return { ...item, status: '已审核' };
                }
                return item;
            });
            if (count > 0) {
                alert(`成功审核 ${count} 份单据`);
                protoSelected.clear();
                renderProtoTable();
            } else {
                alert('勾选的单据中没有可审核（待审核状态）的条目');
            }
        }

        // Modal animations
        function showCancelAuditModal() {
            const modal = document.getElementById('cancel-modal');
            const content = document.getElementById('modal-content');
            const idsText = document.getElementById('modal-ids');
            
            idsText.innerText = Array.from(protoSelected).join(', ');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function hideCancelAuditModal() {
            const modal = document.getElementById('cancel-modal');
            const content = document.getElementById('modal-content');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function confirmProtoCancelAudit() {
            protoData = protoData.map(item => {
                if (protoSelected.has(item.id)) {
                    return { ...item, status: '待审核' };
                }
                return item;
            });
            protoSelected.clear();
            hideCancelAuditModal();
            renderProtoTable();
        }

        // Active link on scroll
        window.addEventListener('scroll', () => {
            const sections = document.querySelectorAll('.doc-section');
            const navLinks = document.querySelectorAll('.nav-link');
            
            let current = "";
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (pageYOffset >= sectionTop - 150) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href').substring(1) === current) {
                    link.classList.add('active');
                }
            });
        });

        // Initialize
        renderProtoTable();
    </script>
</body>
</html>
